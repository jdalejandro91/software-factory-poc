name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
      - 'feature/*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH Key
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Extract Secrets from Env File
        run: |
          echo "${{ secrets.PROD_ENV_FILE }}" | base64 -d > .env
          echo "EC2_HOST=$(grep EC2_HOST .env | cut -d= -f2)" >> $GITHUB_ENV
          echo "EC2_USER=$(grep EC2_USER .env | cut -d= -f2)" >> $GITHUB_ENV

      - name: Deploy to EC2
        run: |
          # 1. Variables de conexi√≥n (desde GITHUB_ENV)
          USER="$EC2_USER"
          HOST="$EC2_HOST"
          KEY="-i ~/.ssh/id_rsa"
          OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          TARGET_DIR="/home/$USER/software-factory-poc"
          BRANCH="${{ github.ref_name }}"

          # 2. Asegurar que la carpeta existe
          ssh $OPTS $KEY $USER@$HOST "mkdir -p $TARGET_DIR"

          # 3. Copiar el archivo .env al servidor
          echo "üîê Enviando configuraci√≥n de entorno (.env)..."
          scp $OPTS $KEY .env $USER@$HOST:$TARGET_DIR/.env

          # 4. Ejecutar el despliegue
          ssh $OPTS $KEY $USER@$HOST << EOF
            set -e
            PROJECT_DIR="\$HOME/software-factory-poc"
            REPO_URL="https://github.com/jdalejandro91/software-factory-poc.git"
            
            cd "\$PROJECT_DIR"
            
            # Auto-healing del repo
            if [ ! -d ".git" ]; then
                echo "‚ö†Ô∏è Repo no detectado o corrupto. Clonando de nuevo..."
                cd ..
                rm -rf software-factory-poc
                git clone "\$REPO_URL" software-factory-poc
                cd software-factory-poc
            fi

            # Actualizar c√≥digo
            echo "üì• Bajando cambios de \$BRANCH..."
            git fetch origin \$BRANCH
            git checkout \$BRANCH
            git reset --hard origin/\$BRANCH

            # Despliegue
            echo "üîÑ Reiniciando contenedores..."
            docker compose down || true
            docker compose up -d --build --remove-orphans
            
            echo "‚úÖ Despliegue completado."
            docker compose ps

            # Smoke Test / Health Check
            echo "‚è≥ Esperando 10 segundos para arranque de Uvicorn..."
            sleep 10
            echo "üè• Ejecutando Smoke Test contra /health..."
            curl --fail --retry 3 --retry-delay 5 --max-time 10 http://localhost:8000/health || (echo "‚ùå Smoke Test Failed" && docker compose logs app && exit 1)
          EOF