name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH Key
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Create .env file from Secret
        run: |
          # Creamos el archivo .env en el runner de GitHub usando el secreto
          echo "${{ secrets.PROD_ENV_FILE }}" > .env.production

      - name: Deploy to EC2
        run: |
          # 1. Definir variables de conexi√≥n
          USER="${{ secrets.EC2_USER }}"
          HOST="${{ secrets.EC2_HOST }}"
          KEY="-i ~/.ssh/id_rsa"
          OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          TARGET_DIR="/home/$USER/software-factory-poc"

          # 2. Asegurar que la carpeta existe antes de copiar nada
          ssh $OPTS $KEY $USER@$HOST "mkdir -p $TARGET_DIR"

          # 3. Copiar el archivo .env al servidor (Inyecci√≥n de Secretos)
          echo "üîê Enviando configuraci√≥n de entorno (.env)..."
          scp $OPTS $KEY .env.production $USER@$HOST:$TARGET_DIR/.env

          # 4. Ejecutar el despliegue
          ssh $OPTS $KEY $USER@$HOST << 'EOF'
            set -e
            PROJECT_DIR="$HOME/software-factory-poc"
            REPO_URL="https://github.com/jdalejandro91/software-factory-poc.git"
            
            cd "$PROJECT_DIR"
            
            # Auto-healing del repo
            if [ ! -d ".git" ]; then
                echo "‚ö†Ô∏è Repo no detectado o corrupto. Clonando de nuevo..."
                cd ..
                rm -rf software-factory-poc
                git clone "$REPO_URL" software-factory-poc
                cd software-factory-poc
            fi

            # Actualizar c√≥digo
            echo "üì• Bajando cambios..."
            git fetch origin main
            git reset --hard origin/main

            # Despliegue
            echo "üîÑ Reiniciando contenedores..."
            docker compose down || true
            docker compose up -d --build --remove-orphans
            
            echo "‚úÖ Despliegue completado."
            docker compose ps
          EOF