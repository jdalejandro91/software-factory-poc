============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.12
cachedir: .pytest_cache
rootdir: /app
configfile: pytest.ini (WARNING: ignoring pytest config in pyproject.toml!)
plugins: anyio-4.12.1
collecting ... collected 1 item

tests/integration/test_jira_scaffolding_flow.py::test_jira_scaffolding_flow_end_to_end FAILED [100%]

=================================== FAILURES ===================================
____________________ test_jira_scaffolding_flow_end_to_end _____________________

    def test_jira_scaffolding_flow_end_to_end():
        # 1. Prepare Payload
        payload = {
            "webhookEvent": "jira:issue_created",
            "timestamp": 123456789,
            "user": {
                "name": "tester",
                "displayName": "Integration Tester",
                "active": True
            },
            "issue": {
                "id": "1001",
                "key": "KAN-123",
                "fields": {
                    "summary": "Implement Shopping Cart Feature",
                    "description": """
    Please create:
    ```scaffolding
    version: '1.0'
    technology_stack: python-api-v1
    target:
      gitlab_project_path: 'mock-group/mock-project'
    parameters:
      service_name: 'shopping-cart-service'
    ```
    Instruction: Create a Python shopping cart with add_item method.
    """,
                    "project": {
                        "key": "KAN",
                        "name": "Kanban Project"
                    }
                }
            },
            "changelog": {
                "id": "9999",
                "items": [
                    {
                        "field": "status",
                        "fieldtype": "jira",
                        "fromString": "Por hacer",
                        "toString": "En curso"
                    }
                ]
            }
        }
    
        # 2. Setup Mocks via Patch (Robust Strategy)
        # We patch the Resolver methods to return our controlled Mocks regardless of lifecycle
        with patch("software_factory_poc.infrastructure.resolution.provider_resolver.ProviderResolver.resolve_llm_gateway") as mock_resolve_llm, \
             patch("software_factory_poc.infrastructure.resolution.provider_resolver.ProviderResolver.resolve_vcs") as mock_resolve_vcs, \
             patch("software_factory_poc.infrastructure.resolution.provider_resolver.ProviderResolver.resolve_tracker") as mock_resolve_tracker, \
             patch("software_factory_poc.infrastructure.resolution.provider_resolver.ProviderResolver.resolve_knowledge") as mock_resolve_knowledge:
    
            # Configure LLM Mock
            mock_llm_instance = MagicMock()
            mock_resolve_llm.return_value = mock_llm_instance
            # Return a valid block so parsing doesn't fail
            mock_llm_instance.generate_code.return_value = (
                "<<<FILE:src/shopping_cart.py>>>\n"
                "class ShoppingCart: pass\n"
                "<<<END>>>"
            )
    
            # Configure VCS Mock
            mock_vcs_instance = MagicMock()
            mock_resolve_vcs.return_value = mock_vcs_instance
            # Simulate branch does not exist so flow proceeds
            mock_vcs_instance.branch_exists.return_value = False
            mock_vcs_instance.create_merge_request.return_value = MergeRequestDTO(id="1", web_url="http://gitlab.mock/mr/1")
    
            # Configure Tracker Mock (Jira)
            mock_tracker_instance = MagicMock()
            mock_resolve_tracker.return_value = mock_tracker_instance
    
            # Configure Knowledge Mock
            mock_knowledge_instance = MagicMock()
            mock_resolve_knowledge.return_value = mock_knowledge_instance
            mock_knowledge_instance.retrieve_context.return_value = "Shopping Cart Architecture (Modular Monolith)\nCart Entity"
    
            # 3. Execution
            # Mock Env headers for auth check
            headers = {"X-API-Key": "test-secret"}
    
            # We also need to ensure settings validation passes if secret is checked.
            # But for this integration test, assuming we have a valid secret or we mock settings.
            # Let's mock the secret env var just in case using MonkeyPatch context
            with pytest.MonkeyPatch.context() as mp:
                mp.setenv("JIRA_WEBHOOK_SECRET", "test-secret")
    
                # The API Router typically instantiates Settings() which reads env.
                response = client.post("/api/v1/jira-webhook", json=payload, headers=headers)
    
                # 4. Verifications
                assert response.status_code == 202
                assert response.json()["status"] == "accepted"
    
                # Verification 1: LLM Interaction
                # Check (assert_called) instead of global variable
                assert mock_llm_instance.generate_code.called
    
                # Inspect the prompt passed to LLM
                call_args = mock_llm_instance.generate_code.call_args
                # access (args, kwargs) from call_args
                args, kwargs = call_args
                prompt_arg = args[0] if args else kwargs.get("prompt")
    
                # 1. Mapper Verification: Prompt contains instruction
                assert "service_name: 'shopping-cart-service'" in prompt_arg
                assert "mock-group/mock-project" in prompt_arg
    
                # 2. Adapter Verification: Prompt contains Architecture Text (from Knowledge Mock)
                assert "Shopping Cart Architecture (Modular Monolith)" in prompt_arg
                assert "Cart Entity" in prompt_arg
    
                # 3. Agent Verification: Constructed structure
                assert "--- ARCHITECTURAL STANDARDS (RAG CONTEXT) ---" in prompt_arg
                assert "--- TASK INSTRUCTIONS ---" in prompt_arg
    
                # 4. Prompt Hardening Verification
                assert "--- CRITICAL OUTPUT RULES ---" in prompt_arg
                assert "--- EXAMPLE OUTPUT ---" in prompt_arg
    
                # Verification 2: Tracker Interaction
                from unittest.mock import call
                # Check sequence of calls
                # 1. Report Start
                # 2. Report Success/Transition (since flow succeeds)
                # Note: The exact messages depend on the implementation.
                # ScaffoldingAgent calls report_start -> report_success -> transition_task
                # UseCase might also call report_failure if it failed.
    
                # Since we didn't mock ScaffoldingAgent internally, we rely on its behavior.
                # Using ANY for the message part to be robust, but verifying sequence.
                from unittest.mock import ANY
    
                mock_tracker_instance.add_comment.assert_has_calls([
                    call("KAN-123", ANY), # Start message
                    call("KAN-123", ANY)  # Success message
                ])
    
                mock_tracker_instance.transition_status.assert_has_calls([
>                   call("KAN-123", TaskStatus.IN_REVIEW)
                                    ^^^^^^^^^^
                ])
E               NameError: name 'TaskStatus' is not defined

tests/integration/test_jira_scaffolding_flow.py:152: NameError
------------------------------ Captured log call -------------------------------
WARNING  software_factory_poc.application.core.domain.agents.research.research_agent:research_agent.py:23 Context retrieval yielded empty or short result for query: python Implement Shopping Cart Feature
=============================== warnings summary ===============================
../usr/local/lib/python3.12/site-packages/_pytest/config/__init__.py:1428
  /usr/local/lib/python3.12/site-packages/_pytest/config/__init__.py:1428: PytestConfigWarning: Unknown config option: asyncio_mode
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/integration/test_jira_scaffolding_flow.py::test_jira_scaffolding_flow_end_to_end
========================= 1 failed, 1 warning in 0.20s =========================
